B. 状压dp。

C. 分情况讨论！！

D. 离散化+BIT。
